package inicio;

import java.sql.*;
import java.util.Scanner;

public class CRUD {
    static Scanner sc = new Scanner(System.in);

    public static void crearTablas(Connection con) {
        String sqlPacientes = "CREATE TABLE Pacientes ("
                + "idPaciente int AUTO_INCREMENT Primary Key,"
                + "nombre varChar(45),"
                + "apellidos varChar(45),"
                + "NSS varChar(11)"
                + ")";
        
        String sqlMedicamentos = "CREATE TABLE Medicamentos ("
                + "idMedicamento int AUTO_INCREMENT Primary Key, "
                + "Composicion varChar(45)"
                + ")";
        
        String sqlReceta = "CREATE TABLE Receta ("
                + "idReceta int AUTO_INCREMENT Primary Key,"
                + "idPaciente int,"
                + "idMedicamento int,"
                + "fechaFin date,"
                + "Constraint Foreign Key (idPaciente) References Pacientes(idPaciente),"
                + "Constraint Foreign Key (idMedicamento) References Medicamentos(idMedicamento)"
                + ")";
        
        try (Statement st = con.createStatement()) {
            st.executeUpdate(sqlPacientes);
            st.executeUpdate(sqlMedicamentos);
            st.executeUpdate(sqlReceta);
            System.out.println("Tablas creadas con éxito.");
        } catch (SQLException e) {
            System.out.println("Error al crear las tablas en la base de datos: " + e.getMessage());
        }
    }

    public static void insertarPaciente(Connection con) {
        System.out.print("Introduce el nombre del paciente: ");
        String nombre = sc.nextLine();
        System.out.print("Introduce los apellidos del paciente: ");
        String apellidos = sc.nextLine();
        System.out.print("Introduce el NSS del paciente: ");
        String nss = sc.nextLine();

        String sql = "INSERT INTO Pacientes (nombre, apellidos, NSS) VALUES (?, ?, ?)";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setString(1, nombre);
            ps.setString(2, apellidos);
            ps.setString(3, nss);
            ps.executeUpdate();
            System.out.println("Paciente insertado correctamente.");
        } catch (SQLException e) {
            System.out.println("Error al insertar el paciente: " + e.getMessage());
        }
    }

    public static void insertarMedicamento(Connection con) {
        System.out.print("Introduce la composición del medicamento: ");
        String composicion = sc.nextLine();

        String sql = "INSERT INTO Medicamentos (composicion) VALUES (?)";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setString(1, composicion);
            ps.executeUpdate();
            System.out.println("Medicamento insertado correctamente.");
        } catch (SQLException e) {
            System.out.println("Error al insertar medicamento: " + e.getMessage());
        }
    }

    public static void insertarReceta(Connection con) {
        System.out.print("Introduce el ID del paciente: ");
        int idPaciente = sc.nextInt();
        sc.nextLine();
        System.out.print("Introduce el ID del medicamento: ");
        int idMedicamento = sc.nextInt();
        sc.nextLine();
        System.out.print("Introduce la fecha de finalización de la receta (YYYY-MM-DD): ");
        String fechaFin = sc.nextLine();

        String sql = "INSERT INTO Receta (idPaciente, idMedicamento, fechaFin) VALUES (?, ?, ?)";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setInt(1, idPaciente);
            ps.setInt(2, idMedicamento);
            ps.setString(3, fechaFin);
            ps.executeUpdate();
            System.out.println("Receta insertada correctamente.");
        } catch (SQLException e) {
            System.out.println("Error al insertar receta: " + e.getMessage());
        }
    }

    public static void listarConFiltro(Connection con, String tabla, String campo, String valor) {
        String sql = "SELECT * FROM " + tabla + " WHERE " + campo + " LIKE ?";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setString(1, "%" + valor + "%");
            ResultSet rs = ps.executeQuery();
            while (rs.next()) {
                imprimirResultado(rs);
            }
        } catch (SQLException e) {
            System.out.println("Error al listar los datos con filtro: " + e.getMessage());
        }
    }

    public static void listarSinFiltro(Connection con, String tabla) {
        String sql = "SELECT * FROM " + tabla;
        try (Statement st = con.createStatement()) {
            ResultSet rs = st.executeQuery(sql);
            while (rs.next()) {
                imprimirResultado(rs);
            }
        } catch (SQLException e) {
            System.out.println("Error al listar los datos sin filtro: " + e.getMessage());
        }
    }

    public static void imprimirResultado(ResultSet rs) throws SQLException {
        ResultSetMetaData rsMetaData = rs.getMetaData();
        int columnCount = rsMetaData.getColumnCount();

        for (int i = 1; i <= columnCount; i++) {
            String columnName = rsMetaData.getColumnName(i);
            String columnValue = rs.getString(i);
            System.out.println(columnName + ": " + columnValue);
        }
        System.out.println("----------------------------------");
    }

    public static void modificarDatos(Connection con) {
        System.out.print("¿En qué tabla quieres modificar los datos? (Pacientes, Medicamentos, Receta): ");
        String tabla = sc.nextLine().toLowerCase();

        System.out.print("Introduce el ID del registro a modificar: ");
        int id = sc.nextInt();
        sc.nextLine();

        try {
            if ("pacientes".equals(tabla)) {
                modificarPaciente(con, id);
            } else if ("medicamentos".equals(tabla)) {
                modificarMedicamento(con, id);
            } else if ("receta".equals(tabla)) {
                modificarReceta(con, id);
            } else {
                System.out.println("Tabla no válida.");
            }
        } catch (SQLException e) {
            System.out.println("Error al modificar los datos: " + e.getMessage());
        }
    }

    private static void modificarPaciente(Connection con, int idPaciente) throws SQLException {
        System.out.print("Introduce el nuevo nombre del paciente: ");
        String nuevoNombre = sc.nextLine();
        System.out.print("Introduce los nuevos apellidos del paciente: ");
        String nuevosApellidos = sc.nextLine();
        System.out.print("Introduce el nuevo NSS del paciente: ");
        String nuevoNSS = sc.nextLine();

        String sql = "UPDATE Pacientes SET nombre = ?, apellidos = ?, NSS = ? WHERE idPaciente = ?";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setString(1, nuevoNombre);
            ps.setString(2, nuevosApellidos);
            ps.setString(3, nuevoNSS);
            ps.setInt(4, idPaciente);
            ps.executeUpdate();
            System.out.println("Paciente modificado correctamente.");
        } catch (SQLException e) {
            System.out.println("Error al modificar el paciente: " + e.getMessage());
        }
    }

    private static void modificarMedicamento(Connection con, int idMedicamento) throws SQLException {
        System.out.print("Introduce la nueva composición del medicamento: ");
        String nuevaComposicion = sc.nextLine();

        String sql = "UPDATE Medicamentos SET Composicion = ? WHERE idMedicamento = ?";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setString(1, nuevaComposicion);
            ps.setInt(2, idMedicamento);
            ps.executeUpdate();
            System.out.println("Medicamento modificado correctamente.");
        } catch (SQLException e) {
            System.out.println("Error al modificar el medicamento: " + e.getMessage());
        }
    }

    private static void modificarReceta(Connection con, int idReceta) throws SQLException {
        System.out.print("Introduce el nuevo ID del paciente: ");
        int nuevoIdPaciente = sc.nextInt();
        System.out.print("Introduce el nuevo ID del medicamento: ");
        int nuevoIdMedicamento = sc.nextInt();
        sc.nextLine();
        System.out.print("Introduce la nueva fecha de finalización de la receta (YYYY-MM-DD): ");
        String nuevaFechaFin = sc.nextLine();

        String sql = "UPDATE Receta SET idPaciente = ?, idMedicamento = ?, fechaFin = ? WHERE idReceta = ?";
        try (PreparedStatement ps = con.prepareStatement(sql)) {
            ps.setInt(1, nuevoIdPaciente);
            ps.setInt(2, nuevoIdMedicamento);
            ps.setString(3, nuevaFechaFin);
            ps.setInt(4, idReceta);
            ps.executeUpdate();
            System.out.println("Receta modificada correctamente.");
        } catch (SQLException e) {
            System.out.println("Error al modificar la receta: " + e.getMessage());
        }
    }

    public static void borrarDatos(Connection con) {
        System.out.println("¿En qué tabla quieres borrar los datos?");
        System.out.println("1. Pacientes");
        System.out.println("2. Medicamentos");
        System.out.println("3. Receta");
        System.out.print("Elige una opción: ");
        int subopcion = sc.nextInt();
        sc.nextLine();

        System.out.print("¿Deseas borrar todos los datos o solo algunos con un filtro? (todos/filtro): ");
        String opcionBorrar = sc.nextLine();

        String tabla = "";
        if (subopcion == 1) {
            tabla = "Pacientes";
        } else if (subopcion == 2) {
            tabla = "Medicamentos";
        } else if (subopcion == 3) {
            tabla = "Receta";
        }

        if ("todos".equalsIgnoreCase(opcionBorrar)) {
            String sql = "DELETE FROM " + tabla;
            try (PreparedStatement ps = con.prepareStatement(sql)) {
                ps.executeUpdate();
                System.out.println("Datos borrados correctamente.");
            } catch (SQLException e) {
                System.out.println("Error al borrar los datos: " + e.getMessage());
            }
        } else if ("filtro".equalsIgnoreCase(opcionBorrar)) {
            System.out.print("Introduce el campo para filtrar: ");
            String campo = sc.nextLine();
            System.out.print("Introduce el valor para filtrar: ");
            String valor = sc.nextLine();
            String sql = "DELETE FROM " + tabla + " WHERE " + campo + " LIKE ?";
            try (PreparedStatement ps = con.prepareStatement(sql)) {
                ps.setString(1, "%" + valor + "%");
                ps.executeUpdate();
                System.out.println("Datos borrados con éxito.");
            } catch (SQLException e) {
                System.out.println("Error al borrar los datos: " + e.getMessage());
            }
        }
    }

    public static void eliminarTablas(Connection con) {
        System.out.println("¿Qué tabla deseas eliminar?");
        System.out.println("1. Pacientes");
        System.out.println("2. Medicamentos");
        System.out.println("3. Receta");
        System.out.print("Elige una opción: ");
        int subopcion = sc.nextInt();
        sc.nextLine();

        String tabla = "";
        if (subopcion == 1) {
            tabla = "Pacientes";
        } else if (subopcion == 2) {
            tabla = "Medicamentos";
        } else if (subopcion == 3) {
            tabla = "Receta";
        }

        System.out.print("¿Estás seguro de que quieres eliminar la tabla " + tabla + "? (S/N): ");
        String confirmacion = sc.nextLine();
        if ("S".equalsIgnoreCase(confirmacion)) {
            String sql = "DROP TABLE " + tabla;
            try (PreparedStatement ps = con.prepareStatement(sql)) {
                ps.executeUpdate();
                System.out.println("Tabla eliminada correctamente.");
            } catch (SQLException e) {
                System.out.println("Error al eliminar la tabla: " + e.getMessage());
            }
        }
    }

    public static void main(String[] args) {
        Connection con = ConexionDB.conectar();

        if (con != null) {
            boolean continuar = true;
            while (continuar) {
                System.out.println("\nMenú de opciones:");
                System.out.println("1. Crear tablas");
                System.out.println("2. Insertar datos");
                System.out.println("3. Modificar datos");
                System.out.println("4. Listar datos");
                System.out.println("5. Borrar datos");
                System.out.println("6. Eliminar tablas");
                System.out.println("7. Salir");
                System.out.print("Elige una opción: ");
                int opcion = sc.nextInt();
                sc.nextLine();

                if (opcion == 1) {
                    crearTablas(con);
                } else if (opcion == 2) {
                    System.out.println("¿En qué tabla quieres insertar los datos?");
                    System.out.println("1. Pacientes");
                    System.out.println("2. Medicamentos");
                    System.out.println("3. Receta");
                    System.out.print("Elige una opción: ");
                    int subopcion = sc.nextInt();
                    sc.nextLine();

                    if (subopcion == 1) {
                        insertarPaciente(con);
                    } else if (subopcion == 2) {
                        insertarMedicamento(con);
                    } else if (subopcion == 3) {
                        insertarReceta(con);
                    }
                } else if (opcion == 3) {
                    modificarDatos(con);
                } else if (opcion == 4) {
                    System.out.println("¿En qué tabla quieres listar los datos?");
                    System.out.println("1. Pacientes");
                    System.out.println("2. Medicamentos");
                    System.out.println("3. Receta");
                    System.out.print("Elige una opción: ");
                    int subopcion = sc.nextInt();
                    sc.nextLine();

                    System.out.print("¿Deseas filtrar los datos? (S/N): ");
                    String filtro = sc.nextLine();
                    if (filtro.equalsIgnoreCase("S")) {
                        System.out.print("Introduce el campo para filtrar: ");
                        String campo = sc.nextLine();
                        System.out.print("Introduce el valor para filtrar: ");
                        String valor = sc.nextLine();
                        if (subopcion == 1) {
                            listarConFiltro(con, "Pacientes", campo, valor);
                        } else if (subopcion == 2) {
                            listarConFiltro(con, "Medicamentos", campo, valor);
                        } else if (subopcion == 3) {
                            listarConFiltro(con, "Receta", campo, valor);
                        }
                    } else {
                        if (subopcion == 1) {
                            listarSinFiltro(con, "Pacientes");
                        } else if (subopcion == 2) {
                            listarSinFiltro(con, "Medicamentos");
                        } else if (subopcion == 3) {
                            listarSinFiltro(con, "Receta");
                        }
                    }
                } else if (opcion == 5) {
                    borrarDatos(con);
                } else if (opcion == 6) {
                    eliminarTablas(con);
                } else if (opcion == 7) {
                    continuar = false;
                    ConexionDB.desconectar(con);
                } else {
                    System.out.println("Opción no válida.");
                }
            }
        } else {
            System.out.println("Error al conectar con la base de datos.");
        }
    }
}
